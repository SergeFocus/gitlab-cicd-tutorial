image: docker:latest
services: 
  - docker:dind

variables:
  WORK_DIR: ${CI_PROJECT_NAME}
  BRANCH: ${CI_COMMIT_REF_NAME}
  REGISTRY: registry.gitlab.com/johandurancerdas/gitlab-cicd-tutorial

stages:
  - build
  - test

build_project:
    stage: build
    script:
        - docker login -u johandurancerdas -p $PASS registry.gitlab.com
        - docker build -t $REGISTRY .
        - docker push $REGISTRY

test_project:
    stage: test
    script:
        - docker login -u johandurancerdas -p $PASS registry.gitlab.com
        - docker pull $REGISTRY
        - docker run --name=$BRANCH -p 80:8080 -i $REGISTRY npm run ci
